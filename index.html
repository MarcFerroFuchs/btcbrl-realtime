<script>
/* ... seu código anterior (chart, setData, etc.) ... */

const SYMBOL = 'BTCBRL';
const INTERVAL = '1m';
const REST_BASE = 'https://api.binance.com';
const WS_URL = `wss://stream.binance.com:9443/ws/${SYMBOL.toLowerCase()}@kline_1m`;

let ws;
let reconnects = 0;
let lastBarTime = null; // mantenha essa variável como no seu código
let pollingTimer = null;

function startPolling() {
  clearInterval(pollingTimer);
  // Busca apenas a última vela (limit=1) a cada 3s
  const url = `${REST_BASE}/api/v3/klines?symbol=${SYMBOL}&interval=${INTERVAL}&limit=1`;
  pollingTimer = setInterval(async () => {
    try {
      const r = await fetch(url);
      if (!r.ok) throw new Error('REST polling falhou');
      const [k] = await r.json();
      const t = Math.floor(k[0] / 1000);
      const bar = { time:t, open:+k[1], high:+k[2], low:+k[3], close:+k[4] };
      // atualiza vela atual ou insere nova
      if (lastBarTime === t) {
        candleSeries.update(bar);
      } else if (lastBarTime == null || t > lastBarTime) {
        candleSeries.update(bar);
        lastBarTime = t;
      }
      // atualize sua UI de preço aqui se tiver (ex.: setPriceUI(bar.close))
    } catch (e) {
      console.error(e);
    }
  }, 3000);
  // opcional: indique no UI que está em modo "polling"
  document.getElementById('conn')?.textContent = 'Atualizando (polling)';
}

function openWS() {
  try { ws?.close(); } catch {}
  ws = new WebSocket(WS_URL);

  ws.onopen = () => {
    reconnects = 0;
    document.getElementById('conn')?.textContent = 'Ao vivo (WebSocket)';
  };

  ws.onmessage = (ev) => {
    const msg = JSON.parse(ev.data);
    const k = msg.k;
    const t = Math.floor(k.t / 1000);
    const bar = { time:t, open:+k.o, high:+k.h, low:+k.l, close:+k.c };

    if (lastBarTime === t) {
      candleSeries.update(bar);
    } else if (lastBarTime == null || t > lastBarTime) {
      candleSeries.update(bar);
      lastBarTime = t;
    }
    // atualize sua UI de preço aqui (ex.: setPriceUI(bar.close))
  };

  ws.onerror = () => {
    try { ws.close(); } catch {}
  };

  ws.onclose = () => {
    // tenta 2 reconexões; depois cai no polling
    if (reconnects < 2) {
      reconnects += 1;
      setTimeout(openWS, 1500);
      document.getElementById('conn')?.textContent = 'Reconectando WS…';
    } else {
      startPolling();
    }
  };
}

/* chame openWS() DEPOIS de carregar o histórico inicial */
openWS();
</script>
